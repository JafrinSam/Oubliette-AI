generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Job {
  id            String   @id @default(uuid())
  status        String   @default("QUEUED") // QUEUED, RUNNING, COMPLETED, FAILED, CANCELLED
  
  // üîó Relations
  dataset       Dataset  @relation(fields: [datasetId], references: [id])
  datasetId     String
  
  // ‚ú® NEW: Store the config used for this job
  hyperparameters Json?   @default("{}") 

  
  script        Script   @relation(fields: [scriptId], references: [id])
  scriptId      String

  runtime       RuntimeImage? @relation(fields: [runtimeId], references: [id])
  runtimeId     String?

  // üê≥ Docker Details
  containerId   String?  // Stores the Container ID immediately after spin-up
  exitCode      Int?
  
  // ‚è±Ô∏è Audit Details
  startedAt     DateTime?
  completedAt   DateTime?
  logPath       String?  // Path to the audit.log file
  
  createdAt     DateTime @default(now())

  
  // OUTPUTS (New Relations)
  producedModelVersion   ModelVersion?
}

model Model {
  id          String         @id @default(uuid())
  name        String         @unique // e.g., "Customer_Churn_Predictor"
  description String?
  
  versions    ModelVersion[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model ModelVersion {
  id          String   @id @default(uuid())
  version     Int      @default(1) // v1, v2, v3
  
  // The physical artifact
  path        String   // Path to folder: storage/models/<model_id>/v<version>/
  sizeBytes   BigInt
  
  // Link back to the Job that created this
  job         Job      @relation(fields: [jobId], references: [id])
  jobId       String   @unique // One job produces one model version
  
  // Parent Model
  model       Model    @relation(fields: [modelId], references: [id])
  modelId     String

  metrics     Json?    // Store accuracy, loss, etc.
  createdAt   DateTime @default(now())

  @@unique([modelId, version])
}

model RuntimeImage {
  id          String   @id @default(uuid())
  name        String
  tag         String   @unique
  dockerId    String   @unique
  sizeBytes   BigInt
  isDefault   Boolean  @default(false)
  
  addedAt     DateTime @default(now())
  
  // Relations
  jobs        Job[]
}


model Dataset {
  id          String   @id @default(uuid())
  name        String   @default("Untitled Dataset") // Logical Name (e.g. "Sales_Data")
  version     Int      @default(1)                  // v1, v2, v3...
  
  filename    String   // Original filename
  hash        String   // Content Hash (Deduplication Key)
  path        String   // Path on disk
  sizeBytes   BigInt
  mimeType    String
  
  uploadedAt  DateTime @default(now())

  // Relations
  jobs        Job[]

  // Allow multiple versions of the same logical name, but version numbers must be unique per name
  @@unique([name, version]) 
}

model Script {
  id            String   @id @default(uuid())
  name          String   @default("Untitled") // Logical Name (e.g., "MNIST_Trainer")
  version       Int      @default(1)
  category      String   @default("General") // e.g., "Preprocessing", "Models"
  filename      String   // Original filename (e.g., "train_model.py")
  
  // üîí Security Fields
  integrityHash String   // SHA-256 of the PLAINTEXT code (Verify before running)
  encryptedPath String   // Path to the .enc file on disk
  encryptionKeyId String? // Optional: If you rotate keys, store which key ID was used
  
  isLatest      Boolean  @default(true)
  uploadedAt    DateTime @default(now())

  // Relations
  jobs          Job[]

  @@unique([name, version])
}